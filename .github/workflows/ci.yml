name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      tools-path: ${{ steps.build.outputs.tools-path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build
        id: build
        run: |
          ./gradlew :tools:build
          ./gradlew :tools:installDist
          echo "tools-path=tools/build/install/tools/bin/tools" >> $GITHUB_OUTPUT

      - name: Run tests
        run: ./gradlew :tools:test

      - name: Validate example calendars
        run: |
          ./tools/build/install/tools/bin/tools validate US-MARKET-BASE
          ./tools/build/install/tools/bin/tools validate US-NYSE
          ./tools/build/install/tools/bin/tools validate US-CORP-IN-VISIBILITY

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: tools/build/reports/tests/

  calendar-diff:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    outputs:
      severity: ${{ steps.diff.outputs.severity }}
      has_changes: ${{ steps.diff.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build tools
        run: ./gradlew :tools:installDist

      - name: Run calendar diff
        id: diff
        run: |
          set +e
          ./tools/build/install/tools/bin/tools ci-diff \
            --blessed-dir blessed \
            --calendars all \
            --output-format json \
            --current-sha "${{ github.sha }}" > diff-result.json 2> diff-error.log
          EXIT_CODE=$?
          set -e

          # Parse results based on exit code
          if [ $EXIT_CODE -eq 0 ]; then
            echo "severity=NONE" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "severity=MINOR" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "severity=MAJOR" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "severity=ERROR" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "::error::Calendar diff failed with exit code $EXIT_CODE"
            echo "--- stderr ---"
            cat diff-error.log
            echo "--- stdout ---"
            cat diff-result.json
            exit 1
          fi

          # Generate markdown report (ignore exit code - we already captured severity above)
          ./tools/build/install/tools/bin/tools ci-diff \
            --blessed-dir blessed \
            --calendars all \
            --output-format markdown \
            --current-sha "${{ github.sha }}" > diff-report.md 2>> diff-error.log || true

          # Always show the report in the logs for visibility
          echo "::group::Calendar Diff Report"
          cat diff-report.md
          echo "::endgroup::"

      - name: Upload diff artifacts
        uses: actions/upload-artifact@v4
        with:
          name: calendar-diff
          path: |
            diff-result.json
            diff-report.md

      - name: Post PR comment
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = fs.readFileSync('diff-report.md', 'utf8');

            // GitHub comment size limit is 65536 characters
            const MAX_SIZE = 60000;
            let truncated = false;

            if (report.length > MAX_SIZE) {
              truncated = true;
              // Find a good break point (end of a line)
              let cutoff = report.lastIndexOf('\n', MAX_SIZE);
              if (cutoff < MAX_SIZE * 0.8) cutoff = MAX_SIZE;
              report = report.substring(0, cutoff);
            }

            let body = report;
            if (truncated) {
              body += '\n\n---\n⚠️ **Report truncated due to size.** See the full report in the [workflow artifacts](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ').';
            }
            body += '\n\n---\n*Generated at: ' + new Date().toISOString() + '*';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## Calendar Diff Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  require-approval:
    runs-on: ubuntu-latest
    needs: calendar-diff
    if: needs.calendar-diff.outputs.has_changes == 'true'

    steps:
      - name: Check for approval label
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.issue?.number;
            console.log(`Checking PR #${prNumber} for approval label`);

            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            console.log(`Found labels: ${labels.map(l => l.name).join(', ')}`);

            const approvalLabel = labels.find(l => l.name === 'calendar-change-approved');
            const severity = '${{ needs.calendar-diff.outputs.severity }}';

            console.log(`Severity: ${severity}, Has approval label: ${!!approvalLabel}`);

            if (severity === 'MAJOR' && !approvalLabel) {
              core.setFailed(
                'MAJOR calendar changes detected. ' +
                'Add the "calendar-change-approved" label after reviewing the diff report.'
              );
            } else if (severity === 'MINOR' && !approvalLabel) {
              core.warning(
                'MINOR calendar changes detected (future events only). ' +
                'Consider adding the "calendar-change-approved" label.'
              );
              // Still fail for consistency - all calendar changes need approval
              core.setFailed(
                'MINOR calendar changes detected. ' +
                'Add the "calendar-change-approved" label to proceed.'
              );
            }

            console.log('Calendar change approved via label');
