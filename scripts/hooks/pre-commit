#!/bin/bash
# Pre-commit hook to ensure staged Java files are formatted.
#
# Note: This runs spotlessApply on the entire tools module, which may reformat
# unstaged files in your working tree. Only the originally staged files are
# re-added to the commit.

# Get the list of staged Java files
STAGED_JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.java$')

if [ -n "$STAGED_JAVA_FILES" ]; then
    echo "Running spotlessApply (formats all Java files in tools module)..."

    # Run spotlessApply on the entire module
    ./gradlew :tools:spotlessApply --quiet

    if [ $? -ne 0 ]; then
        echo "spotlessApply failed. Please fix formatting issues."
        exit 1
    fi

    # Re-add only the originally staged files
    for file in $STAGED_JAVA_FILES; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done

    echo "Formatting applied. Note: unstaged files may also have been reformatted."
fi

exit 0
